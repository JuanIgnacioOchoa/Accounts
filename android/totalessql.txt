select Totales.Cuenta, (CurrentCantidad - COALESCE(Gasto,0) - COALESCE(Ingreso,0)) as Inicial, Totales.CurrentCantidad as Final
from(SELECT t._id as idTotales, sum(Gasto) as Gasto from(
SELECT * FROM Totales WHERE Totales.Activa
) as t
Left outer join (
	SELECT (sum(Cantidad)) as Gasto, idTotales from Movimiento WHERE Cantidad < 0 and strftime('%Y',Fecha) == "2018" and strftime('%m',Fecha) == "07" Group by idTotales
union
select (-1*sum(Cantidad)) as Â¿Gasto, idTotales from Movimiento WHERE Traspaso <> 0 and strftime('%Y',Fecha) == "2018" and strftime('%m',Fecha) == "07" Group by idTotales
) as table3 on t._id == table3.idTotales Group by t._id
) as table1
LEFT OUTER JOIN (
select idTotales, sum(Ingreso) as Ingreso from(
select idTotales, sum(Cantidad) as Ingreso from Movimiento WHERE Cantidad > 0 and Traspaso is null and strftime('%Y',Fecha) == "2018" and strftime('%m',Fecha) == "07" Group by idTotales
union 
select  Traspaso as idTotales, sum(Cantidad) as Ingreso from Movimiento WHERE Traspaso is not null and strftime('%Y',Fecha) == "2018" and strftime('%m',Fecha) == "07" group by Traspaso
) Group by idTotales
) as table2 on table1.idTotales == table2.idTotales, Totales WHERE (Totales._id == table1.idTotales or Totales._id == table2.idTotales) group by Totales._id


---------

select Totales.Cuenta, COALESCE(Gasto,0) as Gasto, COALESCE(Ingreso,0) as Ingreso, (CurrentCantidad - COALESCE(Gasto,0) - COALESCE(Ingreso,0)) as Inicial, Totales.CurrentCantidad as Final
from(SELECT t._id as idTotales, sum(Gasto) as Gasto from(
SELECT * FROM Totales WHERE Totales.Activa
) as t
Left outer join (
	SELECT (sum(CASE WHEN Cambio is not null then cantidad*Cambio else cantidad end )) as Gasto, idTotales from Movimiento WHERE Cantidad < 0 and strftime('%Y',Fecha) == "2018" and strftime('%m',Fecha) == "06" Group by idTotales
union
select (-1*sum(CASE WHEN Cambio is not null and IdMotivo == 2 then cantidad*Cambio else cantidad end )) as Gasto, idTotales from Movimiento WHERE Traspaso is not null and strftime('%Y',Fecha) == "2018" and strftime('%m',Fecha) == "06" Group by idTotales
) as table3 on t._id == table3.idTotales Group by t._id
) as table1
LEFT OUTER JOIN (
select idTotales, sum(Ingreso) as Ingreso from(
select idTotales, sum(CASE WHEN Cambio is not null then cantidad*Cambio else cantidad end ) as Ingreso from Movimiento WHERE Cantidad > 0 and Traspaso is null and strftime('%Y',Fecha) == "2018" and strftime('%m',Fecha) == "06" Group by idTotales
union 
select  Traspaso as idTotales, sum(CASE WHEN Cambio is not null and IdMotivo <> 2 then cantidad*Cambio else cantidad end ) as Ingreso from Movimiento WHERE Traspaso is not null and strftime('%Y',Fecha) == "2018" and strftime('%m',Fecha) == "06" group by Traspaso
) Group by idTotales
) as table2 on table1.idTotales == table2.idTotales, Totales WHERE (Totales._id == table1.idTotales or Totales._id == table2.idTotales) group by Totales._id



select cant, Totales._id, Totales.Cuenta, COALESCE(Gasto,0) as Gasto, COALESCE(Ingreso,0) as Ingreso, (CurrentCantidad - COALESCE(Gasto,0) - COALESCE(Ingreso,0)) as Inicial, Totales.CurrentCantidad as Final
from(SELECT t._id as idTotales, sum(Gasto) as Gasto, cant from(
SELECT Totales._id, Totales.Cuenta, COUNT(Totales._id) as cant FROM Totales, Movimiento  WHERE Movimiento.IdTotales == Totales._id and Totales.Activa || 
(strftime('%Y',Fecha) == "2016" and strftime('%m',Fecha) == "06") group by Totales._id
) as t
Left outer join (
	SELECT (sum(CASE WHEN Cambio is not null then cantidad*Cambio else cantidad end )) as Gasto, idTotales from Movimiento WHERE Cantidad < 0 and strftime('%Y',Fecha) == "2016" and strftime('%m',Fecha) == "06" Group by idTotales
union
select (-1*sum(CASE WHEN Cambio is not null and IdMotivo == 2 then cantidad*Cambio else cantidad end )) as Gasto, idTotales from Movimiento WHERE Traspaso is not null and strftime('%Y',Fecha) == "2016" and strftime('%m',Fecha) == "06" Group by idTotales
) as table3 on t._id == table3.idTotales Group by t._id
) as table1
LEFT OUTER JOIN (
select idTotales, sum(Ingreso) as Ingreso from(
select idTotales, sum(CASE WHEN Cambio is not null then cantidad*Cambio else cantidad end ) as Ingreso from Movimiento WHERE Cantidad > 0 and Traspaso is null and strftime('%Y',Fecha) == "2016" and strftime('%m',Fecha) == "06" Group by idTotales
union 
select  Traspaso as idTotales, sum(CASE WHEN Cambio is not null and IdMotivo <> 2 then cantidad*Cambio else cantidad end ) as Ingreso from Movimiento WHERE Traspaso is not null and strftime('%Y',Fecha) == "2016" and strftime('%m',Fecha) == "06" group by Traspaso
) Group by idTotales
) as table2 on table1.idTotales == table2.idTotales, Movimiento, Totales WHERE (Totales._id == table1.idTotales or Totales._id == table2.idTotales) group by Totales._id



select idTotales from(
select totales.*, Movimiento.* 
from Totales
	LEFT JOIN Movimiento
		on Totales._id = Movimiento.IdTotales
WHERE ((strftime('%Y',Fecha) == "2016" and strftime('%m',Fecha) == "02"))
Union all
Select Totales.* , Movimiento.*
from Movimiento
	LEFT JOIN Totales
		On Totales._id = Movimiento.IdTotales Where Totales.Activa) group by idTotales